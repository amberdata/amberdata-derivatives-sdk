name: Derivatives SDK Tests

# on:
#     schedule:
#       - cron: "*/30 * * * *"
on:
    pull_request:
        branches:
        - main
        - master

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      API_KEY: ${{ secrets.API_KEY }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v3

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install deprecation python-dotenv requests jsonschema

    - name: Run unit tests
      run: python3 -m unittest -v tests/*.py

    # - name: Notify Slack on failure
    #   if: failure()
    #   run: |
    #     curl -X POST -H 'Content-type: application/json' \
    #     --data "{\"text\":\"Unit tests failed for ${GITHUB_REPOSITORY}. Please check the details.\", \"username\": \"CI Bot\", \"icon_emoji\": \":robot_face:\"}" \
    #     ${{ secrets.SDK_SLACK_WEBHOOK }}

    - name: Trigger Opsgenie Webhook on failure
      if: failure()
      run: |
        curl -X POST -H "Content-Type: application/json" \
        --data '{
            "action": "triggered",
            "repository": {
                "name": "'${GITHUB_REPOSITORY}'"
            },
            "sender": {
                "login": "'${GITHUB_ACTOR}'"
            },
            "ref": "'${GITHUB_REF}'",
            "workflow": "Derivatives SDK Tests",
            "run_id": "'${GITHUB_RUN_ID}'",
            "run_number": "'${GITHUB_RUN_NUMBER}'",
            "job": "test",
            "conclusion": "failure",
            "details_url": "https://github.com/'${GITHUB_REPOSITORY}'/actions/runs/'${GITHUB_RUN_ID}'"
            }' \
            https://api.opsgenie.com/v1/json/github?apiKey=${{ secrets.OPSGENIE_API_KEY }}
